{% extends 'base.html' %}
{% load currency %}

{% block page_title %}Repayments{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}"><i class='bx bx-home'></i> Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'view_all_loans' %}">Loans</a></li>
        <li class="breadcrumb-item active" aria-current="page">Repayments</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-end mb-4">
    <div class="d-flex gap-2 align-items-center">
        {% if not loan %}
        <div class="input-group">
            <span class="input-group-text">Select Loan</span>
            <select class="form-select" onchange="if(this.value){ location.href='?loan='+this.value }">
                <option value="">-- choose --</option>
                {% for l in loans %}
                    <option value="{{ l.id }}">{{ l.loan_number|default:'N/A' }} - {{ l.member.full_name }}</option>
                {% endfor %}
            </select>
        </div>
        {% else %}
        {% if loan.status != 'closed' %}
        <button class="btn btn-primary" onclick="showRepaymentForm()">
            <i class='bx bx-plus'></i> Add Repayment
        </button>
        {% else %}
        <span class="text-muted">
            <i class='bx bx-check-circle'></i> Loan Fully Repaid
        </span>
        {% endif %}
        {% endif %}
    </div>
</div>

{% if loan %}
<!-- Loan Info Card -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h6 class="mb-1">
                    <i class='bx bx-credit-card text-primary'></i> 
                    {{ loan.loan_number|default:'N/A' }}
                </h6>
                <p class="mb-1 text-muted">
                    <strong>Member:</strong> {{ loan.member.full_name }} | 
                    <strong>Amount:</strong> {{ loan.amount_requested|ugx }} | 
                    <strong>Status:</strong> 
                    <span class="badge bg-{% if loan.status == 'active' %}primary{% elif loan.status == 'disbursed' %}success{% elif loan.status == 'closed' %}success{% else %}secondary{% endif %}">
                        {{ loan.get_status_display }}
                    </span>
                </p>
            </div>
            <div class="col-md-4 text-end">
                <small class="text-muted">
                    <i class='bx bx-calendar'></i> 
                    Applied: {{ loan.application_date|date:"M d, Y" }}
                </small>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if loan and loan.status != 'closed' %}
<div class="card mb-4" id="repaymentFormCard" style="display: none;">
    <div class="card-header">
        <h6 class="mb-0">Add Repayment for {{ loan.member.full_name }}</h6>
    </div>
    <div class="card-body">
        <form method="post" id="repaymentForm">
            {% csrf_token %}
            <input type="hidden" name="loan_id" value="{{ loan.id }}">
            
            <!-- Loan Info Section -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <strong>Loan:</strong> {{ loan.loan_number }} - {{ loan.member.full_name }}
                        <br><small class="text-muted">Amount Requested: {{ loan.amount_requested|ugx }} | Status: {{ loan.get_status_display }}</small>
                    </div>
                </div>
            </div>
            
            <!-- Payment Details Section -->
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Total Repayment Amount <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">UGX</span>
                        <input type="number" step="0.01" class="form-control" name="amount" required placeholder="0.00">
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Payment Method <span class="text-danger">*</span></label>
                    <select class="form-select" name="payment_method" required>
                        <option value="">Select method</option>
                        <option value="Mobile Money">Mobile Money</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Reference Number</label>
                    <input type="text" class="form-control" name="reference_number" placeholder="Optional reference">
                </div>
            </div>
            
            <!-- Amount Breakdown Section -->
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Applied to Principal</label>
                    <div class="input-group">
                        <span class="input-group-text">UGX</span>
                        <input type="number" step="0.01" class="form-control" name="applied_to_principal" placeholder="Auto-calculated">
                    </div>
                    <small class="form-text text-muted">Leave blank for auto-calculation (70% of total)</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Applied to Interest</label>
                    <div class="input-group">
                        <span class="input-group-text">UGX</span>
                        <input type="number" step="0.01" class="form-control" name="applied_to_interest" placeholder="Auto-calculated">
                    </div>
                    <small class="form-text text-muted">Leave blank for auto-calculation (30% of total)</small>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class='bx bx-save'></i> Add Repayment
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideRepaymentForm()">
                        <i class='bx bx-x'></i> Cancel
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if loan and loan.status == 'closed' %}
<!-- Loan Fully Repaid Message -->
<div class="card mb-4">
    <div class="card-body text-center">
        <div class="alert alert-success">
            <i class='bx bx-check-circle display-4 text-success mb-3'></i>
            <h5 class="alert-heading">Loan Fully Repaid!</h5>
            <p class="mb-0">
                This loan has been completely repaid and closed. 
                No further repayments can be added.
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover data-table">
                <thead>
                    <tr>
                        <th>Loan #</th>
                        <th>Member</th>
                        <th>Amount</th>
                        <th>Principal</th>
                        <th>Interest</th>
                        <th>Payment Date</th>
                        <th>Method</th>
                        <th>Reference</th>
                        <th>Days Left</th>
                    </tr>
                </thead>
                <tbody>
                    {% for repayment in repayments %}
                    <tr>
                        <td>{{ repayment.loan.loan_number }}</td>
                        <td>{{ repayment.loan.member.full_name }}</td>
                        <td>{{ repayment.amount|ugx }}</td>
                        <td>{{ repayment.applied_to_principal|ugx }}</td>
                        <td>{{ repayment.applied_to_interest|ugx }}</td>
                        <td>{{ repayment.payment_date|date:"M d, Y" }}</td>
                        <td>{{ repayment.payment_method }}</td>
                        <td>{{ repayment.reference_number|default:"N/A" }}</td>
                        <td>
                            {% if repayment.loan.maturity_date %}
                                {% now "Y-m-d" as today %}
                                {% with days_left=repayment.loan.maturity_date|timeuntil %}
                                    <span class="badge {% if repayment.loan.maturity_date|timeuntil|slice:":1" == "0" %}bg-danger{% elif repayment.loan.maturity_date|timeuntil|slice:":1" == "1" %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ repayment.loan.maturity_date|timeuntil|slice:":2" }} days
                                    </span>
                                {% endwith %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center">No repayments found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showRepaymentForm() {
    document.getElementById('repaymentFormCard').style.display = 'block';
    document.querySelector('button[onclick="showRepaymentForm()"]').style.display = 'none';
}

function hideRepaymentForm() {
    document.getElementById('repaymentFormCard').style.display = 'none';
    document.querySelector('button[onclick="showRepaymentForm()"]').style.display = 'inline-block';
    // Clear form
    document.getElementById('repaymentForm').reset();
}

// Auto-refresh days left every minute
setInterval(function() {
    // Reload the page to update days left
    location.reload();
}, 60000); // 60 seconds
</script>
{% endblock %}







