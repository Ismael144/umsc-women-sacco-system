{% extends 'base.html' %}
{% load static %}

{% block page_title %}Manage Regions{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
    /* Custom styling for manage regions */
    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
    }
    
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0 !important;
        border: none;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 0.375rem;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #e9ecef;
        padding: 0.875rem 1.25rem;
        transition: all 0.3s ease;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .table {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .table thead th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1.25rem 1rem;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    
    .table tbody tr {
        transition: all 0.3s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.05);
        transform: translateY(-1px);
    }
    
    .table tbody td {
        padding: 1.25rem 1rem;
        vertical-align: middle;
        font-size: 0.9rem;
        line-height: 1.6;
    }
    
    .badge {
        font-size: 0.8rem;
        padding: 0.6rem 0.9rem;
        border-radius: 0.375rem;
        font-weight: 500;
        letter-spacing: 0.3px;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem;
        margin: 0 3px;
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
    
    /* Typography improvements */
    .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        line-height: 1.4;
        margin-bottom: 0.5rem;
    }
    
    .card-body {
        padding: 2rem;
    }
    
    .card-header {
        padding: 1.5rem 2rem;
    }
    
    .mb-3 {
        margin-bottom: 1.5rem !important;
    }
    
    .mb-4 {
        margin-bottom: 2rem !important;
    }
    
    /* Text hierarchy */
    h1, h2, h3, h4, h5, h6 {
        line-height: 1.3;
        margin-bottom: 1rem;
    }
    
    p {
        line-height: 1.6;
        margin-bottom: 1rem;
    }
    
    .text-muted {
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem 0.5rem 0 0;
        padding: 1.5rem 2rem;
    }
    
    .modal-header .btn-close {
        filter: invert(1);
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .modal-footer {
        padding: 1.5rem 2rem;
        border-top: 1px solid #e9ecef;
    }
    
    /* Select2 customization */
    .select2-container--bootstrap-5 .select2-selection {
        border-radius: 0.375rem;
        border: 1px solid #e9ecef;
        min-height: 2.75rem;
        padding: 0.5rem 0.75rem;
    }
    
    .select2-container--bootstrap-5 .select2-selection:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        padding-left: 0;
        padding-right: 0;
        line-height: 1.5;
    }
    
    /* DataTables customization */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        margin-bottom: 1.5rem;
        padding: 1rem 0;
    }
    
    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
        border-radius: 0.375rem;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 0.375rem;
        margin: 0 3px;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        color: white !important;
    }
    
    /* Additional spacing improvements */
    .row {
        margin-bottom: 1.5rem;
    }
    
    .col-md-6 {
        margin-bottom: 1rem;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        line-height: 1.4;
    }
    
    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}"><i class='bx bx-home'></i> Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Manage Regions</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Create Region Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="avatar-sm rounded-circle bg-white bg-soft me-3">
                            <i class="bx bx-plus font-size-24 text-primary"></i>
                        </div>
                        <div>
                            <h4 class="card-title mb-0 text-white">Add New Region</h4>
                            <p class="text-white-50 mb-0">Create a new region for organizing Saccos</p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="createRegionForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="name" class="form-label">
                                        <i class="bx bx-map me-1"></i>Region Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="name" name="name" required 
                                           placeholder="Enter region name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="description" class="form-label">
                                        <i class="bx bx-detail me-1"></i>Description
                                    </label>
                                    <textarea class="form-control" id="description" name="description" rows="4" 
                                              placeholder="Enter region description (optional)"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bx bx-plus me-1"></i>Create Region
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Regions List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="avatar-sm rounded-circle bg-white bg-soft me-3">
                            <i class="bx bx-map font-size-24 text-primary"></i>
                        </div>
                        <div>
                            <h4 class="card-title mb-0 text-white">All Regions</h4>
                            <p class="text-white-50 mb-0">Manage and organize your regions</p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="regionsTable" class="table table-hover data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Saccos Count</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for region in regions %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm rounded-circle bg-primary bg-soft me-2">
                                                <i class="bx bx-map font-size-16 text-primary"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">{{ region.name }}</h6>
                                                <small class="text-muted">ID: {{ region.id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-wrap" style="max-width: 200px;">
                                            {{ region.description|truncatechars:50|default:"No description" }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if region.is_active %}success{% else %}danger{% endif %} fs-6">
                                            <i class="bx bx-{% if region.is_active %}check-circle{% else %}x-circle{% endif %} me-1"></i>
                                            {% if region.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-info me-2">{{ region.saccos.count }}</span>
                                            <small class="text-muted">Saccos</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="fw-medium">{{ region.created_at|date:"M d, Y" }}</div>
                                            <small class="text-muted">{{ region.created_at|date:"H:i" }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    data-bs-toggle="modal" data-bs-target="#editRegionModal{{ region.id }}"
                                                    title="Edit Region">
                                                <i class="bx bx-edit"></i>
                                            </button>
                                            <form method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="toggle_status">
                                                <input type="hidden" name="region_id" value="{{ region.id }}">
                                                <button type="submit" class="btn btn-sm btn-outline-{% if region.is_active %}warning{% else %}success{% endif %}"
                                                        title="{% if region.is_active %}Deactivate{% else %}Activate{% endif %} Region">
                                                    <i class="bx bx-{% if region.is_active %}pause{% else %}play{% endif %}"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Edit Region Modal -->
                                <div class="modal fade" id="editRegionModal{{ region.id }}" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm rounded-circle bg-white bg-soft me-3">
                                                        <i class="bx bx-edit font-size-20 text-primary"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="modal-title text-white mb-0">Edit Region</h5>
                                                        <small class="text-white-50">Update region information</small>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form method="post" id="editRegionForm{{ region.id }}">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="update">
                                                <input type="hidden" name="region_id" value="{{ region.id }}">
                                                <div class="modal-body">
                                                    <div class="row g-4">
                                                        <div class="col-md-6">
                                                            <div class="mb-4">
                                                                <label for="edit_name_{{ region.id }}" class="form-label">
                                                                    <i class="bx bx-map me-1"></i>Region Name <span class="text-danger">*</span>
                                                                </label>
                                                                <input type="text" class="form-control" id="edit_name_{{ region.id }}" 
                                                                       name="name" value="{{ region.name }}" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-4">
                                                                <label for="edit_status_{{ region.id }}" class="form-label">
                                                                    <i class="bx bx-toggle-left me-1"></i>Status
                                                                </label>
                                                                <select class="form-select" id="edit_status_{{ region.id }}" name="is_active">
                                                                    <option value="true" {% if region.is_active %}selected{% endif %}>Active</option>
                                                                    <option value="false" {% if not region.is_active %}selected{% endif %}>Inactive</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mb-4">
                                                        <label for="edit_description_{{ region.id }}" class="form-label">
                                                            <i class="bx bx-detail me-1"></i>Description
                                                        </label>
                                                        <textarea class="form-control" id="edit_description_{{ region.id }}" 
                                                                  name="description" rows="4" placeholder="Enter region description">{{ region.description }}</textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                        <i class="bx bx-x me-1"></i>Cancel
                                                    </button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="bx bx-save me-1"></i>Update Region
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No regions found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTables
    $('#regionsTable').DataTable({
        responsive: true,
        pageLength: 10,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
        order: [[4, 'desc']], // Sort by created date
        columnDefs: [
            { orderable: false, targets: [5] }, // Actions column
            { className: "text-center", targets: [2, 3] }, // Status and count columns
        ],
        language: {
            search: "Search regions:",
            lengthMenu: "Show _MENU_ regions per page",
            info: "Showing _START_ to _END_ of _TOTAL_ regions",
            infoEmpty: "No regions found",
            infoFiltered: "(filtered from _MAX_ total regions)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        buttons: [
            {
                extend: 'excel',
                text: '<i class="bx bx-file"></i> Export Excel',
                className: 'btn btn-success btn-sm',
                title: 'Regions Report'
            },
            {
                extend: 'pdf',
                text: '<i class="bx bx-file-pdf"></i> Export PDF',
                className: 'btn btn-danger btn-sm',
                title: 'Regions Report'
            },
            {
                extend: 'print',
                text: '<i class="bx bx-printer"></i> Print',
                className: 'btn btn-info btn-sm',
                title: 'Regions Report'
            }
        ],
        initComplete: function() {
            // Add custom styling to DataTables elements
            $('.dataTables_length select').addClass('form-select form-select-sm');
            $('.dataTables_filter input').addClass('form-control form-control-sm');
        }
    });


    // Form validation and submission
    $('#createRegionForm').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        const submitBtn = form.find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        // Show loading state
        submitBtn.html('<i class="bx bx-loader-alt bx-spin me-1"></i>Creating...');
        submitBtn.prop('disabled', true);
        
        // Submit form
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                // Show success message
                showNotification('Region created successfully!', 'success');
                
                // Reset form
                form[0].reset();
                
                // Reload page after a short delay
                setTimeout(() => {
                    location.reload();
                }, 1500);
            },
            error: function(xhr) {
                showNotification('Error creating region. Please try again.', 'error');
            },
            complete: function() {
                // Reset button
                submitBtn.html(originalText);
                submitBtn.prop('disabled', false);
            }
        });
    });

    // Edit form submission
    $('[id^="editRegionForm"]').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        const submitBtn = form.find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        // Show loading state
        submitBtn.html('<i class="bx bx-loader-alt bx-spin me-1"></i>Updating...');
        submitBtn.prop('disabled', true);
        
        // Submit form
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            success: function(response) {
                showNotification('Region updated successfully!', 'success');
                
                // Close modal
                form.closest('.modal').modal('hide');
                
                // Reload page after a short delay
                setTimeout(() => {
                    location.reload();
                }, 1500);
            },
            error: function(xhr) {
                showNotification('Error updating region. Please try again.', 'error');
            },
            complete: function() {
                // Reset button
                submitBtn.html(originalText);
                submitBtn.prop('disabled', false);
            }
        });
    });

    // Toggle status confirmation
    $('form[action*="toggle_status"]').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        const regionId = form.find('input[name="region_id"]').val();
        const isActive = form.find('button[type="submit"]').hasClass('btn-outline-warning');
        const action = isActive ? 'deactivate' : 'activate';
        
        if (confirm(`Are you sure you want to ${action} this region?`)) {
            form.off('submit').submit();
        }
    });

    // Notification function
    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'bx-check-circle' : 'bx-x-circle';
        
        const notification = $(`
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="bx ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            notification.alert('close');
        }, 5000);
    }

    // Add smooth animations
    $('.card').each(function(index) {
        $(this).css({
            'opacity': '0',
            'transform': 'translateY(20px)'
        }).delay(index * 100).animate({
            'opacity': '1'
        }, 600).css('transform', 'translateY(0)');
    });
});
</script>
{% endblock %}
